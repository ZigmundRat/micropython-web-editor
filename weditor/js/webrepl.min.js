var term,ws,connected=!1,binary_state=0,put_file_name=null,put_file_data=null,get_file_name=null,get_file_data=null;function calculate_size2(win){return[0|Math.max(80,Math.min(150,(win.innerWidth-280)/7)),0|Math.max(24,Math.min(80,(win.innerHeight-180)/12))]}function calculate_size(win){return[0|Math.max(0,Math.min(150,(win.offsetWidth+10)/7)),0|Math.max(24,Math.min(60,(win.offsetHeight-100)/12))]}function show_https_warning(){var warningDiv;"https:"==window.location.protocol&&((warningDiv=document.createElement("div")).style.cssText="background:#f99;padding:5px;margin-bottom:10px;line-height:1.5em;text-align:center",warningDiv.innerHTML=["The WebREPL client cannot be accessed over HTTPS connections.","Load the WebREPL client from the device instead."].join("<br>"),document.body.insertBefore(warningDiv,document.body.childNodes[0]),term.resize(term.cols,term.rows-7))}function button_click(){connected?ws.close():(document.getElementById("url").disabled=!0,document.getElementById("button").value="Disconnect",connected=!0,connect(document.getElementById("url").value))}function prepare_for_connect(){}function update_file_status(s){}function connect(url){url.substring(5);document.location.host,(ws=new WebSocket(url)).binaryType="arraybuffer",ws.onopen=function(){term.removeAllListeners("data"),term.on("data",function(data){data=data.replace(/\n/g,"\r"),ws.send(data)}),term.on("title",function(title){document.title=title}),term.focus(),term.element.focus(),term.write("[31mWelcome to MicroPython![m\r\n"),ws.onmessage=function(event){if(event.data instanceof ArrayBuffer){var data=new Uint8Array(event.data);switch(binary_state){case 11:if(0==decode_resp(data)){for(var offset=0;offset<put_file_data.length;offset+=1024)ws.send(put_file_data.slice(offset,offset+1024));binary_state=12}break;case 12:0==decode_resp(data)?update_file_status("Sent "+put_file_name+", "+put_file_data.length+" bytes"):update_file_status("Failed sending "+put_file_name),binary_state=0;break;case 21:0==decode_resp(data)&&(binary_state=22,(rec=new Uint8Array(1))[0]=0,ws.send(rec));break;case 22:var rec,sz=data[0]|data[1]<<8;data.length==2+sz?0==sz?binary_state=23:((sz=new Uint8Array(get_file_data.length+sz)).set(get_file_data),sz.set(data.slice(2),get_file_data.length),update_file_status("Getting "+get_file_name+", "+(get_file_data=sz).length+" bytes"),(rec=new Uint8Array(1))[0]=0,ws.send(rec)):binary_state=0;break;case 23:0==decode_resp(data)?(update_file_status("Got "+get_file_name+", "+get_file_data.length+" bytes"),saveAs(new Blob([get_file_data],{type:"application/octet-stream"}),get_file_name)):update_file_status("Failed getting "+get_file_name),binary_state=0;break;case 31:console.log("GET_VER",data),binary_state=0}}term.write(event.data)}},ws.onclose=function(){connected=!1,term&&term.write("[31mDisconnected[m\r\n"),term.off("data"),prepare_for_connect()}}function decode_resp(data){return data[0]=="W".charCodeAt(0)&&data[1]=="B".charCodeAt(0)?data[2]|data[3]<<8:-1}function put_file(){var dest_fname=put_file_name,dest_fsize=put_file_data.length,rec=new Uint8Array(82);rec[0]="W".charCodeAt(0),rec[1]="A".charCodeAt(0),rec[2]=1,rec[3]=0,rec[4]=0,rec[5]=0,rec[6]=0,rec[7]=0,rec[8]=0,rec[9]=0,rec[10]=0,rec[11]=0,rec[12]=255&dest_fsize,rec[13]=dest_fsize>>8&255,rec[14]=dest_fsize>>16&255,rec[15]=dest_fsize>>24&255,rec[16]=255&dest_fname.length,rec[17]=dest_fname.length>>8&255;for(var i=0;i<64;++i)i<dest_fname.length?rec[18+i]=dest_fname.charCodeAt(i):rec[18+i]=0;binary_state=11,update_file_status("Sending "+put_file_name+"..."),ws.send(rec)}function get_file(){var src_fname=document.getElementById("get_filename").value,rec=new Uint8Array(82);rec[0]="W".charCodeAt(0),rec[1]="A".charCodeAt(0),rec[2]=2,rec[3]=0,rec[4]=0,rec[5]=0,rec[6]=0,rec[7]=0,rec[8]=0,rec[9]=0,rec[10]=0,rec[11]=0,rec[12]=0,rec[13]=0,rec[14]=0,rec[15]=0,rec[16]=255&src_fname.length,rec[17]=src_fname.length>>8&255;for(var i=0;i<64;++i)i<src_fname.length?rec[18+i]=src_fname.charCodeAt(i):rec[18+i]=0;binary_state=21,get_file_name=src_fname,get_file_data=new Uint8Array(0),update_file_status("Getting "+get_file_name+"..."),ws.send(rec)}function get_ver(){var rec=new Uint8Array(82);rec[0]="W".charCodeAt(0),rec[1]="A".charCodeAt(0),rec[2]=3,binary_state=31,ws.send(rec)}function handle_put_file_select(evt){var evt=evt.target.files[0],reader=(put_file_name=evt.name,new FileReader);reader.onload=function(e){put_file_data=new Uint8Array(e.target.result),document.getElementById("put-file-list").innerHTML=escape(put_file_name)+" - "+put_file_data.length+" bytes",document.getElementById("put-file-button").disabled=!1},reader.readAsArrayBuffer(evt)}!function(){window.onload=function(){window.location.hash.substring(1)||document.location.host;var size=calculate_size(document.getElementById("term"));(term=new Terminal({cols:size[0],rows:size[1],useStyle:!0,screenKeys:!0,cursorBlink:!1})).open(document.getElementById("term")),connect("ws://"+window.location.host+":8266")},window.addEventListener("resize",function(){var size=calculate_size(document.getElementById("term"));term.resize(size[0],size[1])})}.call(this);
